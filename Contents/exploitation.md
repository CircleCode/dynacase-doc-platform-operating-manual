# Procédures d'exploitation


## Archivage et restauration de contextes

Vous reportez au chapitre Gestion des contextes.

## Sauvegarde du répertoire du contexte

Le répertoire du contexte contient des ficheirs et des répertoires qui peuvent être sauvegardés de manière standard
avec des outils comme `tar`:

    [bash]
    tar zcf /backup/dynacase.context.tar.gz /var/www/dynacase

Afin de réduire la durée de sauvegarde vous pouvez exclure les éléments suivant de la sauvegarde de ce répertoire et qui seront régénérés dynamiquement après la restauration :
> sessions/ : sous-répertoire contenant les sessions PHP.
> .img-resize/ : sous-répertoire de cache d'images.

Vous pouvez aussi effectuer une sauvegarde incrémentale des fichiers du répertoire du contexte.

## Sauvegarde de la base de données

La sauvegarde de la base de données s'effectue par un dump complet à l'aide de la commande `pg_dump` :

    [bash]
    PGSERVICE=dynacase pg_dump | gzip > /backup/dynacase.pg_dump.gz

## Sauvegarde du vault

Le vault, comme le répertoire du contexte, peut être sauvegardé avec des outils standards comme `tar` :

    [bash]
    tar zcf /backup/dynacase.vault.tar.gz /var/vault

Une sauvegarde incrémentale est aussi possible pour ce répertoire.

## Mise en service du contexte

Une fois les éléments sauvegardés, l'accès au contexte peut-être ré-ouvert :

    [bash]
    /var/www/dynacase-control/wiff wstart <nomDuContexte>

## Restauration

L'ordre de restauration des éléments s'effectue de manière inverse à leur sauvegarde.

### Restauration des vaults
Restauration des fichiers précédemment archivés :

    [bash]
    tar -C / -zxf /backup/dynacase.vault.tar.gz

### Restauration de la base de données
Restauration du dump de la base de données :

    [bash]
    gzip -dc /backup/dynacase.pg_dump.gz | PGSERVICE=dynacase psql

### Restauration du répertoire du contexte
Restauration des fichiers du contexte :

    [bash]
    tar -C / -zxf /backup/dynacase.context.tar.gz

### Ré-enregistrement des crontab

    [bash]
    /var/www/dynacase-control/wiff context <nomDuContexte>

### wstart
Comme la sauvegarde a été effectués en mode maintenance `wstop`, il faut à la fin ré-ouvrir l'accès avec `wstart` :

    [bash]
    /var/www/dynacase-control/wiff wstart <nomDuContexte>

## Check base documentaire


Une liste de vérification de problèmes pouvant se produire sur une installation Dynacase est disponible dans le sous-répertoire 'admin' du contexte et accessible par l'URL : `http://<nomDuServeur>/admin`, rubrique `DB consistency`.

L'interface présente alors une liste de vérification avec un statut : vert pour "OK", rouge pour "KO".

### *main connection db* :
Vérifier que Postgresql est bien lancé

### *unreference user in group* :
Supprimer les références :

    [sql]
    DELETE FROM groups where iduser not in (select id from users);

### *user as group* :
Par exemple _user as group1 users detected as group 25_. Peut arriver par un import sql qui
écraserait les utilisateurs

Soit mettre les utilisateurs comme groupe (mettre l'attribut isgroup à Y dans la table users) ou supprimer la référence dans la table groupe :

    [sql]
    dynacase=# BEGIN;
    dynacase=# DELETE FROM groups WHERE idgroup not in (select id from users where isgroup='Y');
    DELETE 110
    dynacase=# COMMIT;
    COMMIT

Et exécuter cette commande :

    [bash]
    /var/www/dynacase-control/wiff context <nomDuContexte> exec ./wsh --api=freedom_groups

### *unreference actions* : peut arriver lors de suppression d'applications
Appliquer le fichier sql /var/www/dynacase/WHAT/what_clean.sql sur la base principale

### *unreference parameters* ; peut arriver lors de suppression d'applications

Appliquer le fichier sql /var/www/dynacase/WHAT/what_clean.sql sur la base principale

### *unreference acl* :
Appliquer le fichier sql /var/www/dynacase/WHAT/what_clean.sql sur la base principale

### *unreference permission* :
Appliquer le fichier sql /var/www/dynacase/WHAT/what_clean.sql sur la base principale

### *connection db freedom* :
 Idem. "main connection db"

### *double doc id* :
Par exemple 1 double id detected
Array
(
    [1178] => 2
)

Plusieurs documents ont le même identifiant numérique. Peut arriver lors d'importation avec des identificateurs fixe ou lors d'importation avec des familles inexistantes.
Remède :

Supprimer l'un des doublons (ou les deux)

    [sql]
      dynacase=# SELECT id,count(*) FROM doc GROUP BY id HAVING count(*) > 1;
        id  | count
      ------+-------
       1178 |     2

Détail des enregistrements posant problème :

    [sql]
      dynacase=# SELECT id, title, fromid, locked FROM doc WHERE id = 1178;
        id  |      title      | fromid | locked
      ------+-----------------+--------+--------
       1178 | Fiche de suivi  |      0 |      0
       1178 | Dossier EI auto |   1169 |      0

Suppression de l'enregistrement incorrecte :

    {sql]
       dynacase=# DELETE FROM doc WHERE id = 1178 AND fromid = 0;
       DELETE 1

### *double doc name* : plusieurs documents ont le même identifiant logique (attribut name)

Supprimer l'un des doublons (ou les deux)

### *multiple alive revision*

Exemple : 2 multiple alive
Array (
  [73780] => jean-raymond.durand@example.net
  [85480] => Restauration groupe test
)

Plusieurs révisions “vivante” sur un même document. Cela peut arriver sur d'ancienne version (< 2.14) lorsque deux tentatives de révisions simultanées sont créés ou si par programmation on force des restauration.

    [sql]
     dynacase=# SELECT id, title FROM docread WHERE id IN (SELECT m AS id FROM (SELECT min(id) AS m, initid, count(initid) AS c FROM docread WHERE locked != -1 AND doctype != 'T' GROUP BY docread.initid) AS z WHERE z.c > 1);
       id   |                        title
     -------+-----------------------------------------------------
      73780 | jean-raymond.durand@example.net
      85480 | Restauration groupe test
     (2 lignes)

     # /var/www/dynacase-control/wiff context <nomDuContexte> exec ./wsh.php --api=fixMultipleAliveRevision
     Fixing mutiple alive revision for (initid='35198', id='85480')
     Fixing mutiple alive revision for (initid='56405', id='73780')


### *family inheritance*

Exemple :
	Family [44232]: fromid = 0, pg inherit=
	Family [44237]: fromid = 0, pg inherit=
	Family [44241]: fromid = 0, pg inherit=
	...
L'héritage déclaré par la famille ne correspont pas à celle défini dans postgresql. Peut arriver si on change l'héritage d'une famille ou si une famille est créée avant la famille père.

Identifier les enregistrement posant problème :

    [sql]
       dynacase=# SELECT id, title, fromid, locked, doctype FROM doc WHERE fromid = 0 AND doctype IS NULL;
         id   | title | fromid | locked | doctype
       -------+-------+--------+--------+---------
        44232 |       |      0 |      0 |
        44237 |       |      0 |      0 |
        44241 |       |      0 |      0 |
        ...

Supprimer les enregistrements :

    [sql]
        dynacase=# DELETE FROM doc WHERE fromid = 0 AND doctype IS NULL;
      DELETE 14

Ou supprimer le table correspondante et lancer :

       # /var/www/dynacase-control/wiff context <nomDuContexte> exec ./wsh --api=fdl_adoc --docid=<N°famille>



### *connection db webdav* :
si le module WORKSPACE est installé

### *connection USER LDAP* :
si le module NETWORKUSER est installé

## Miroir local des paquets


Si la machine sur laquelle est installé Dynacase n'a pas accès à Internet, vous pouvez créer un miroir local HTTP/FTP du dépôt de paquets en ligne.

    [bash]
    $ mkdir /var/www/mirror
    $ cd /var/www/mirror
    $ wget --mirror --level=1 --no-parent "http://eec.anakeen.com/public/control/?F=0"  # dynacase-control
    $ wget --mirror --level=1 --no-parent "http://eec.anakeen.com/public/platform/?F=0" # dynacase-platform
    $ wget --mirror --level=1 --no-parent "http://ftp.dynacase.org/third-party/?F=0"    # third-party elements

Les paquets du dépôt *platform* font référence a des éléments additionnels téléchargés sur *http://ftp.dynacase.org*. Pour pouvoir être installés depuis le miroir il faut donc modifier ces paquets pour y inscrire la nouvelle racine pour le téléchargement de ces éléments additionnels.

Pour cela, *dynacase-control* fournit l'outils *sedwebinst.php* dans le sous-répertoire *utils* du répertoire d'installation de dynacase-control.

Cet outils prend 3 arguments qui sont :

1. l'URL à modifier ;
2. la nouvelle URL d'accès aux éléments de *third-party* sur votre miroir ;
3. et enfin le répertoire d'accès au dépôt des paquets de platform qui contient les fichiers *webinst*.


    [bash]
    $ php /var/www/dynacase-control/utils/sedwebinst.php \
        http://ftp.dynacase.org/third-party \
        http://localhost/mirror/ftp.dynacase.org/third-party \
        /var/www/mirror/eec.anakeen.com/public/platform/

Configurer ensuite votre serveur Web pour servir ce répertoire *mirror*, et modifier les paramètres par défaut du dépôt ”dynacase” pour pointer sur ce nouveau dépôt.

    Dynacase-Control > Setup
    Repositories > “dynacase” > Modify
        Protocol : [http                                     ]
        Host     : [localhost                                ]
        Path     : [/mirror/eec.anakeen.com/public/platform  ]

Ajuster ensuite les paramètres `wiff-update-host` et `wiff-update-path` de l'installeur Dynacase-control pour chercher les mises-à-jour de l'installeur sur ce nouveau dépôt :

    # vi /var/www/dynacase-control/conf/params.xml
    [...]
            <param name="wiff-update-host" value="http://localhost/"/>
            <param name="wiff-update-path" value="mirror/eec.anakeen.com/public/control/"/>
    [...]

## Exploitation des logs

Après chaque exécution de procédures automatiques (cron), des logs sont enregistrés dans le syslog.
Ils contiennent le titre et l'id du processus exécuté, ainsi que le statut de l'exécution (0 en cas de succès) et le temps d'exécution de la procédure:

    Aug 30 10:18:15 pc-de-test [I] Dynacase:CORE:WELCOME: []  Default Master [1] - : Process FDL IMPCARD [3355] executed in 1.005 seconds

Le même système est en place à chaque exécution de timer (minuteur).

L'api dynacaseDbCleaner produit, elle aussi, des logs. Ces logs sont de la forme:

    Aug 27 09:25:55 ubuntu1004server dynacaseDbCleaner(CORE_CLIENT): DELETE 0
    Aug 27 09:25:55 ubuntu1004server dynacaseDbCleaner(CORE_CLIENT): Temps : 3,868 ms

Chaque commande sql lancée par le dynacasDbCleaner est enregistrée. Le nom du client (paramétré à la configuration)
est affiché à la place de `CORE_CLIENT`.

## Suppression dépôts de paquets `freedom-ecm.org`

Les premières versions de Freedom et Dynacase étaient hébergés sur des serveurs du domaine `freedom-ecm.org`.

Suite au changement de nom, ce domaine n'est plus valide et vous ne devez plus utiliser de dépôts de paquets qui font référence à ce domaine.

Pour supprimer les références à ces anciens dépôts de paquets, vous pouvez soit les supprimer manuellement, soit utiliser le script `utils/remove_freedom_ecm_repos.php` fournit avec les dernières versions de `dynacase-control` pour supprimer automatiquement ces dépôts.

Le script fonctionne en mode notification (pour vous informer de la présence de dépôts invalides) ou en mode suppression (pour supprimer les dépôts invalides rencontrés).

Mode notification (mode par défaut) :

    # cd /var/www/dynacase-control
    # php utils/remove_freedom_ecm_repos.php
    * Inspecting repository list...
    Found invalid repository 'invalid1' with host 'ftp.freedom-ecm.org'.
    Found invalid repository 'invalid2' with host 'ftp.freedom-ecm.org'.

    Re-run with '--remove' argument to remove the invalid repositories.

Mode suppression (option `--remove`) :

    # cd /var/www/dynacase-control
    # php utils/remove_freedom_ecm_repos.php --remove
    * Inspecting repository list...
    Found invalid repository 'invalid1' with host 'ftp.freedom-ecm.org'.
    Found invalid repository 'invalid2' with host 'ftp.freedom-ecm.org'.
    * Deactivating repository 'invalid1' on context 'c1'.
    Done.
    * Deactivating repository 'invalid1' on context 'c2'.
    Done.
    * Deactivating repository 'invalid2' on context 'c2'.
    Done.
    * Deleting repository 'invalid1'.
    Done.
    * Deleting repository 'invalid2'.
    Done.
