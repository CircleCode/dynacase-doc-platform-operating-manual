# Procédures d'exploitation

## Sauvegarde et restauration de contextes {#exploitation-save-restore}

La sauvegarde se différencie de l'[archivage](#manage-context-archivage) par le fait que la sauvegarde est une opération effectuée par le service d'exploitation système, et qu'il peut s'intégrer plus facilement dans les procédures mises en place par le service informatique.
Ce chapitre va donc présenter les éléments à sauvegarder en se focalisant sur les aspects systèmes.

### Éléments d'un contexte Dynacase

Un contexte Dynacase est composé des éléments suivants :

* Le répertoire du contexte : il contient le code PHP des applications et des familles de documents.
* La base de données : elle contient les documents et le paramétrage Dynacase.
* Le ou les vaults : ils contiennent les fichiers insérés dans les documents Dynacase.

### Sauvegarde

La sauvegarde se déroulera selon les étapes suivantes:

1. Désactivation du contexte
2. Sauvegarde du répertoire applicatif
3. Sauvegarde de la base de données
4. Sauvegarde du vault
5. Réactivation du contexte

#### Blocage des accès au contexte

Afin d'assurer l'intégrité des données, l'accès au contexte sera bloqué afin que les utilisateurs ne puissent pas modifier les données durant le déroulement de la sauvegarde.
Pour cela il faudra lancer la commande `wstop` dans le contexte Dynacase qu'on sauvegarde :

    [bash]
    /var/www/dynacase-control/wiff wstop <nomDuContexte>

#### Sauvegarde du répertoire du contexte

Le répertoire du contexte contient des fichiers et des répertoires qui peuvent être sauvegardés de manière standard avec des outils comme `tar`:

    [bash]
    tar zcf /backup/dynacase.context.tar.gz <répertoire du contexte>

Afin de réduire la durée de sauvegarde vous pouvez exclure les éléments généré dynamiquement.
Ces éléments sont :

* le répertoire `sessions/` : sous-répertoire contenant les sessions PHP.
* le répertoire `img-resize/` : sous-répertoire de cache d'images.

Vous pouvez aussi effectuer une sauvegarde incrémentale des fichiers du répertoire du contexte.

#### Sauvegarde de la base de données

La sauvegarde de la base de données s'effectue par un dump complet à l'aide de la commande `pg_dump` :

    [bash]
    PGSERVICE=dynacase pg_dump | gzip > /backup/dynacase.pg_dump.gz

#### Sauvegarde du vault

Le vault, comme le répertoire du contexte, peut être sauvegardé avec des outils standards comme `tar` :

    [bash]
    tar zcf /backup/dynacase.vault.tar.gz /var/vault

Une sauvegarde incrémentale est aussi possible pour ce répertoire.

#### Restauration de l'accès au contexte

Une fois les éléments sauvegardés, l'accès au contexte peut-être ré-ouvert :

    [bash]
    /var/www/dynacase-control/wiff wstart <nomDuContexte>

### Restauration

L'ordre de restauration des éléments s'effectue de manière inverse à leur sauvegarde :

1. restauration du vault
2. restauration de la base de données
3. restauration du répertoire applicatif
4. Réactivation du contexte

#### Restauration des vaults
Restauration des fichiers précédemment archivés :

    [bash]
    tar -C / -zxf /backup/dynacase.vault.tar.gz

#### Restauration de la base de données

    [bash]
    gzip -dc /backup/dynacase.pg_dump.gz | PGSERVICE=dynacase psql

#### Restauration du répertoire du contexte
Restauration des fichiers du contexte :

    [bash]
    tar -C / -zxf /backup/dynacase.context.tar.gz

Note : Pour accélerer le chargement des données, vous pouvez consulter la section [Bulk data loading](#752E8DED-D951-42E9-BF23-73AD28622D03) pour un exemple de paramétrage de Postgresql.

#### Ré-enregistrement des crontab

    [bash]
    /var/www/dynacase-control/wiff context <nomDuContexte>
    ./wsh.php --api=crontab --cmd=register --file=APPNAME/file.cron

#### wstart

Comme la sauvegarde a été effectués en mode maintenance `wstop`, il faut à la fin ré-ouvrir l'accès avec `wstart` :

    [bash]
    /var/www/dynacase-control/wiff wstart <nomDuContexte>

## Check base documentaire

Une liste de vérification de problèmes pouvant se produire sur une installation Dynacase est disponible dans le sous-répertoire 'admin' du contexte et accessible par l'URL : *http://&lt;nomDuServeur>/admin*, rubrique *DB consistency*.

L'interface présente alors une liste de vérification avec un statut : vert pour "OK", rouge pour "KO".

main connection db
:   Vérifie que Postgresql est bien lancé

onnection db freedom
:   Vérifie que Postgresql est bien lancé

unreference user in group
:   Vérifie les inconsistences de la table groups.  
    Solution : Supprimer les références erronées

    [sql]
    DELETE FROM groups where iduser not in (select id from users);

user as group
:   Par exemple *user as group1 users detected as group 25*. Peut arriver par un import sql qui écraserait les utilisateurs.  
    Solution : Soit mettre les utilisateurs comme groupe (mettre l'attribut isgroup à Y dans la table users) ou supprimer la référence dans la table groupe, puis raffraichir la table users :

    [sql]
    dynacase=# BEGIN;
    dynacase=# DELETE FROM groups WHERE idgroup not in (select id from users where isgroup='Y');
    DELETE 110
    dynacase=# COMMIT;
    COMMIT

puis :

    [bash]
    /var/www/dynacase-control/wiff context <nomDuContexte> exec ./wsh --api=freedom_groups

unreference actions
:   peut arriver lors de la suppression d'applications.  
    Solution : Appliquer le fichier sql `/var/www/dynacase/WHAT/what_clean.sql` sur la base principale.

unreference parameters
:   peut arriver lors de la suppression d'applications  
    Solution : Appliquer le fichier sql `/var/www/dynacase/WHAT/what_clean.sql` sur la base principale.

unreference acl
:   peut arriver lors de la suppression d'applications  
    Solution : Appliquer le fichier sql `/var/www/dynacase/WHAT/what_clean.sql` sur la base principale.

unreference permission
:   peut arriver lors de la suppression d'applications  
    Solution : Appliquer le fichier sql `/var/www/dynacase/WHAT/what_clean.sql` sur la base principale.


double doc id
:   Plusieurs documents ont le même identifiant numérique. Peut arriver lors d'importation avec des identificateurs fixe ou lors d'importation avec des familles inexistantes.
    Par exemple :  
    1 double id detected  
    Array  
    (  
        [1178] => 2  
    )  
    Solution : Supprimer l'un des doublons (ou les deux)

Obtenir la liste des ids posant problème :

    [sql]
      dynacase=# SELECT id,count(*) FROM doc GROUP BY id HAVING count(*) > 1;
        id  | count
      ------+-------
       1178 |     2

Obtenir le détail des enregistrements posant problème :

    [sql]
      dynacase=# SELECT id, title, fromid, locked FROM doc WHERE id = 1178;
        id  |      title      | fromid | locked
      ------+-----------------+--------+--------
       1178 | Fiche de suivi  |      0 |      0
       1178 | Dossier EI auto |   1169 |      0

Suppression de l'enregistrement incorrect :

    [sql]
    dynacase=# DELETE FROM doc WHERE id = 1178 AND fromid = 0;
    DELETE 1

double doc name
:   plusieurs documents ont le même identifiant logique (propriété *name*)  
    Solution : Supprimer l'un des doublons (ou les deux)

multiple alive revision
:   Plusieurs révisions sont *vivantes* pour un même document. Cela peut arriver sur d'ancienne version (< 2.14) lorsque deux tentatives de révisions simultanées sont créés ou si par programmation on force des restauration.  
    Par exemple :  
    2 multiple alive  
    Array (  
        [73780] => jean-raymond.durand@example.net  
        [85480] => Restauration groupe test  
    )  
    Solution : utiliser l'API *fixMultipleAliveRevision*

Obtenir le détail des enregistrements posant problème :

    [sql]
     dynacase=# SELECT id, title FROM docread WHERE id IN (SELECT m AS id FROM (SELECT min(id) AS m, initid, count(initid) AS c FROM docread WHERE locked != -1 AND doctype != 'T' GROUP BY docread.initid) AS z WHERE z.c > 1);
       id   |                        title
     -------+-----------------------------------------------------
      73780 | jean-raymond.durand@example.net
      85480 | Restauration groupe test
     (2 lignes)

API *fixMultipleAliveRevision* :

    [bash]
    # /var/www/dynacase-control/wiff context <nomDuContexte> exec ./wsh.php --api=fixMultipleAliveRevision
    Fixing mutiple alive revision for (initid='35198', id='85480')
    Fixing mutiple alive revision for (initid='56405', id='73780')


family inheritance
:   L'héritage déclaré par la famille ne correspont pas à celle défini dans postgresql. Peut arriver si on change l'héritage d'une famille ou si une famille est créée avant sa famille père.  
    Exemple :  
    Family [44232]: fromid = 0, pg inherit=  
    Family [44237]: fromid = 0, pg inherit=  
    Family [44241]: fromid = 0, pg inherit=  
    …  
    Solution : restaurer l'héritage

Identifier les enregistrement posant problème :

    [sql]
    dynacase=# SELECT id, title, fromid, locked, doctype FROM doc WHERE fromid = 0 AND doctype IS NULL;
    id   | title | fromid | locked | doctype
    -----+-------+--------+--------+---------
    44232 |       |      0 |      0 |
    44237 |       |      0 |      0 |
    44241 |       |      0 |      0 |
    …

Supprimer les enregistrements :

    [sql]
    dynacase=# DELETE FROM doc WHERE fromid = 0 AND doctype IS NULL;
    DELETE 14

Ou supprimer la table correspondante et lancer :

    [bash]
    # /var/www/dynacase-control/wiff context <nomDuContexte> exec ./wsh --api=fdl_adoc --docid=<N°famille>

connection db webdav
:   Vérifie la disponibilité de la table webdav (si le module WORKSPACE est installé)

connection USER LDAP
:   Vérifie le lien avec le LDAP (si le module NETWORKUSER est installé)

## Miroir local des paquets

Si la machine sur laquelle est installé Dynacase n'a pas accès à Internet, vous pouvez créer un miroir local HTTP/FTP du dépôt de paquets en ligne.

    [bash]
    $ mkdir /var/www/mirror
    $ cd /var/www/mirror
    $ wget --mirror --level=1 --no-parent "http://eec.anakeen.com/public/control/?F=0"  # dynacase-control
    $ wget --mirror --level=1 --no-parent "http://eec.anakeen.com/public/platform/?F=0" # dynacase-platform
    $ wget --mirror --level=1 --no-parent "http://ftp.dynacase.org/third-party/?F=0"    # third-party elements

Les paquets du dépôt *dynacase-platform* font référence à des éléments additionnels téléchargés sur *http://ftp.dynacase.org* (dépôt *third-party elements*). Pour pouvoir être installés depuis le miroir il faut donc modifier ces paquets pour y inscrire la nouvelle racine pour le téléchargement de ces éléments additionnels.

Pour cela, *dynacase-control* fournit l'outils `sedwebinst.php` dans le sous-répertoire `utils` du répertoire d'installation de dynacase-control.

Cet outils prend 3 arguments qui sont :

1. l'URL à modifier ;
2. la nouvelle URL d'accès aux éléments de *third-party* sur votre miroir ;
3. et enfin le répertoire d'accès au dépôt des paquets de platform qui contient les fichiers *webinst*.

    [bash]
    $ php /var/www/dynacase-control/utils/sedwebinst.php \
        http://ftp.dynacase.org/third-party \
        http://localhost/mirror/ftp.dynacase.org/third-party \
        /var/www/mirror/eec.anakeen.com/public/platform/

Configurer ensuite votre serveur Web pour servir ce répertoire `mirror`, et configurer un dépôt pointant sur ce répertoire (voir [la gestion des dépôts](#installation-control-repositories)).

Ajuster ensuite les paramètres *wiff-update-host* et *wiff-update-path* de l'installeur Dynacase-control pour chercher les mises-à-jour de l'installeur sur ce nouveau dépôt (voir [la configuration des mises-à-jour de Dynacase Control](#installation-control-update)).

## Exploitation des logs

Les logs de Dynacase Platform sont gérés au moyen de syslog.
Dynacase Platform logue par défaut tous ses messages avec la facilité *LOG_LOCAL6*, à l'exception des erreurs d'authentification, qui sont journalisées avec la facilité *LOG_AUTH* (à moins que vous ayiez changé cette valeur au moyen du paramètre applicatif *AUTH_LOGFACILITY*).

Le formatage des logs suit la règle suivante: *[&lt;code>] Dynacase &lt;application> &lt;fonction> &lt;message>*, avec :

code
:   Le code de log, correspondant à la priorité :

* D pour la priorité DEBUG
* O pour les appels de fonction deprecated (priorité INFO)
* I pour la priorité INFO
* W pour la priorité WARNING
* E pour la priorité ERROR
* F pour la priorité ALERT

application
:   l'application, si définie, sous la forme *:application*

fonction
:   la fonction, si définie, sous la forme *:fonction*

Après chaque exécution de procédures automatiques (cron), des logs sont enregistrés dans le syslog.
Ils contiennent le titre et l'id du processus exécuté, ainsi que le statut de l'exécution (0 en cas de succès) et le temps d'exécution de la procédure:

    Aug 30 10:18:15 pc-de-test [I] Dynacase:CORE:WELCOME: []  Default Master [1] - : Process FDL IMPCARD [3355] executed in 1.005 seconds

Le même système est en place à chaque exécution de timer (minuteur).

L'api dynacaseDbCleaner produit, elle aussi, des logs. Ces logs sont de la forme:

    Aug 27 09:25:55 ubuntu1004server dynacaseDbCleaner(CORE_CLIENT): DELETE 0
    Aug 27 09:25:55 ubuntu1004server dynacaseDbCleaner(CORE_CLIENT): Temps : 3,868 ms

Chaque commande sql lancée par le dynacasDbCleaner est enregistrée. Le nom du client (paramétré à la configuration)
est affiché à la place de *CORE_CLIENT*.

## Suppression dépôts de paquets *freedom-ecm.org*

Les premières versions de Freedom et Dynacase étaient hébergés sur des serveurs du domaine *freedom-ecm.org*.

Suite au changement de nom, ce domaine n'est plus valide et vous ne devez plus utiliser de dépôts de paquets qui font référence à ce domaine.

Pour supprimer les références à ces anciens dépôts de paquets, vous pouvez soit les supprimer manuellement, soit utiliser le script `utils/remove_freedom_ecm_repos.php` fourni avec les dernières versions de dynacase-control pour supprimer automatiquement ces dépôts.

Le script fonctionne en mode notification (pour vous informer de la présence de dépôts invalides) ou en mode suppression (pour supprimer les dépôts invalides rencontrés).

Mode notification (mode par défaut) :

    # cd /var/www/dynacase-control
    # php utils/remove_freedom_ecm_repos.php
    * Inspecting repository list...
    Found invalid repository 'invalid1' with host 'ftp.freedom-ecm.org'.
    Found invalid repository 'invalid2' with host 'ftp.freedom-ecm.org'.

    Re-run with '--remove' argument to remove the invalid repositories.

Mode suppression (option `--remove`) :

    # cd /var/www/dynacase-control
    # php utils/remove_freedom_ecm_repos.php --remove
    * Inspecting repository list...
    Found invalid repository 'invalid1' with host 'ftp.freedom-ecm.org'.
    Found invalid repository 'invalid2' with host 'ftp.freedom-ecm.org'.
    * Deactivating repository 'invalid1' on context 'c1'.
    Done.
    * Deactivating repository 'invalid1' on context 'c2'.
    Done.
    * Deactivating repository 'invalid2' on context 'c2'.
    Done.
    * Deleting repository 'invalid1'.
    Done.
    * Deleting repository 'invalid2'.
    Done.
